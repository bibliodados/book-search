<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Buscador de Livros ‚Äî Multibases + MARC Bibliogr√°fico e Autoridade</title>
<style>
/* =========================
   VARI√ÅVEIS DE TEMA
   ========================= */
:root{
  /* Escuro (padr√£o) */
  --bg:#0f172a;
  --panel:#111827;
  --muted:#94a3b8;
  --text:#e5e7eb;
  --primary:#38bdf8;
  --primary-2:#0ea5e9;
  --accent:#22c55e;
  --warn:#f59e0b;
  --error:#ef4444;
  --chip:#1f2937;
  --chip-text:#e5e7eb;
  --card:#0b1220;
  --surface:#0b1220;
  --codebg:#020617;
  --border-rgba:148,163,184;
  --br:14px;
  --shadow:0 10px 30px rgba(0,0,0,.35);
  --toast-bg:#001018;
  --toast-text:#a7f3d0;
  --grad-a: rgba(56,189,248,.15);
  --grad-b: rgba(34,197,94,.12);
  --sk-a:#101826; --sk-b:#0f192a;
}
/* Claro */
html[data-theme="light"]{
  --bg:#f8fafc;
  --panel:#ffffff;
  --muted:#475569;
  --text:#0f172a;
  --primary:#0ea5e9;
  --primary-2:#0284c7;
  --accent:#16a34a;
  --warn:#d97706;
  --error:#dc2626;
  --chip:#eef2f7;
  --chip-text:#0f172a;
  --card:#ffffff;
  --surface:#f8fafc;
  --codebg:#f3f4f6;
  --border-rgba:15,23,42;
  --shadow:0 6px 24px rgba(2,6,23,.08);
  --toast-bg:#e6fffa;
  --toast-text:#065f46;
  --grad-a: rgba(56,189,248,.18);
  --grad-b: rgba(34,197,94,.14);
  --sk-a:#e5e7eb; --sk-b:#f1f5f9;
}
/* Pref do SO na primeira carga */
@media (prefers-color-scheme: light){
  html:not([data-theme="dark"]){
    --bg:#f8fafc; --panel:#ffffff; --muted:#475569; --text:#0f172a;
    --primary:#0ea5e9; --primary-2:#0284c7; --accent:#16a34a;
    --warn:#d97706; --error:#dc2626; --chip:#eef2f7; --chip-text:#0f172a;
    --card:#ffffff; --surface:#f8fafc; --codebg:#f3f4f6; --border-rgba:15,23,42;
    --shadow:0 6px 24px rgba(2,6,23,.08);
    --toast-bg:#e6fffa; --toast-text:#065f46;
    --grad-a: rgba(56,189,248,.18); --grad-b: rgba(34,197,94,.14);
    --sk-a:#e5e7eb; --sk-b:#f1f5f9;
  }
}

/* =========================
   BASE
   ========================= */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;
  background:
    radial-gradient(1200px 700px at 100% -10%, var(--grad-a), rgba(0,0,0,0) 60%),
    radial-gradient(1200px 700px at -10% 110%, var(--grad-b), rgba(0,0,0,0) 60%),
    var(--bg);
  color:var(--text);
}
.container{max-width:1080px;margin:40px auto;padding:0 16px}

/* Cabe√ßalho + Toggle */
.header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px}
h1{
  flex:1;
  font-weight:800; letter-spacing:.4px; margin:0 0 8px;
  background:linear-gradient(90deg,var(--primary),#a78bfa,#f472b6);
  -webkit-background-clip:text; background-clip:text; color:transparent;
  text-align:center; font-size:clamp(28px,4vw,40px)
}
.theme-toggle{
  white-space:nowrap; display:inline-flex; align-items:center; gap:8px;
  padding:8px 12px; border-radius:999px; background:var(--panel);
  border:1px solid rgba(var(--border-rgba),.18); color:var(--text);
  cursor:pointer; font-weight:700; box-shadow:var(--shadow)
}
.theme-toggle .icon{font-size:16px}
.theme-toggle .label{font-size:13px; opacity:.9}

.sub{ text-align:center; color:var(--muted); margin-bottom:22px; font-size:14px }

/* Cart√£o de busca */
.card{
  background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
  border:1px solid rgba(var(--border-rgba),.15);
  border-radius:var(--br); padding:18px; box-shadow:var(--shadow)
}
.grid{display:grid; gap:12px; grid-template-columns: 2fr 2fr 1fr}
.grid-compl{display:grid; gap:12px; grid-template-columns: 1fr 1fr 1.2fr}
input,button,textarea{
  width:100%; padding:12px 14px; border-radius:10px;
  border:1px solid rgba(var(--border-rgba),.18);
  background:var(--surface); color:var(--text); outline:none
}
button.cta{
  background:linear-gradient(180deg,var(--primary),var(--primary-2)); border:none; font-weight:800; color:#001018;
  cursor:pointer; transition: transform .04s ease
}
button.cta:active{transform:translateY(1px)}
button.ghost{
  background:var(--panel); color:var(--text);
  border:1px solid rgba(var(--border-rgba),.25); font-weight:700
}
button.ghost:hover{border-color:var(--primary); color:var(--primary)}
.small-btn{
  padding:10px 12px; white-space:nowrap; border-radius:10px;
  border:1px solid rgba(var(--border-rgba),.25); background:var(--panel); color:var(--text); font-weight:700; cursor:pointer
}

/* Painel de fontes (chips com contraste em ambos temas) */
.sources{ display:flex; flex-wrap:wrap; gap:8px; margin:12px 0 4px }
.chip{
  display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px;
  background:var(--chip);
  border:1px solid rgba(var(--border-rgba),.28);
  color:var(--chip-text); font-size:13px; font-weight:600;
  box-shadow: inset 0 -1px 0 rgba(255,255,255,.04);
}
.chip .dot{width:8px;height:8px;border-radius:50%; background:var(--muted)}
.chip.ok{color:#052e1a; background:rgba(34,197,94,.18); border-color:rgba(34,197,94,.35)}
.chip.ok .dot{background:var(--accent)}
.chip.warn{color:#3b2402; background:rgba(245,158,11,.18); border-color:rgba(245,158,11,.38)}
.chip.warn .dot{background:var(--warn)}
.chip.err{color:#3a0303; background:rgba(239,68,68,.18); border-color:rgba(239,68,68,.38)}
.chip.err .dot{background:var(--error)}

/* Skeleton + resultados */
.skeleton{ display:none; margin:18px 0; gap:16px; grid-template-columns: 220px 1fr }
.skeleton.show{display:grid}
.sk-thumb{height:320px; border-radius:12px; background:linear-gradient(90deg,var(--sk-a),var(--sk-b),var(--sk-a)); background-size:200% 100%; animation:sh 1.4s infinite}
.sk-line{height:14px; border-radius:6px; background:linear-gradient(90deg,var(--sk-a),var(--sk-b),var(--sk-a)); background-size:200% 100%; animation:sh 1.4s infinite}
@keyframes sh{0%{background-position:0 0}100%{background-position:200% 0}}

.result{ display:none; margin:18px 0; gap:18px; grid-template-columns: 260px 1fr }
.result.show{display:grid}
.cover{
  background:var(--card); border:1px solid rgba(var(--border-rgba),.18); border-radius:12px; padding:10px;
  display:flex; flex-direction:column; gap:10px; align-items:center
}
.cover img{max-width:100%; border-radius:10px; box-shadow:var(--shadow)}
.carousel{display:flex; gap:8px; overflow:auto; padding-bottom:6px}
.carousel img{height:68px; border-radius:8px; opacity:.85; cursor:pointer; border:1px solid transparent}
.carousel img:hover{opacity:1; border-color:var(--primary)}
.meta{ background:var(--card); border:1px solid rgba(var(--border-rgba),.18); border-radius:12px; padding:16px }
.kv{display:grid; grid-template-columns: 160px 1fr; gap:8px; font-size:14px}
.kv div:nth-child(odd){color:var(--muted)}
.links{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
a.btn{
  text-decoration:none; background:linear-gradient(180deg,#1f2937,#111827);
  border:1px solid rgba(var(--border-rgba),.2); padding:8px 12px; border-radius:10px; color:var(--text); font-weight:600
}
html[data-theme="light"] a.btn{ background:linear-gradient(180deg,#ffffff,#f8fafc) }
a.btn:hover{border-color:var(--primary); color:var(--primary)}

.meta-tabs{display:flex; gap:6px; margin-top:14px; flex-wrap:wrap}
.meta-tab{
  padding:8px 10px; border-radius:10px; border:1px solid rgba(var(--border-rgba),.18);
  background:var(--surface); cursor:pointer; font-weight:700; color:var(--text)
}
.meta-tab.active{background:linear-gradient(180deg,var(--primary),var(--primary-2)); color:#001018}
.meta-panels{margin-top:10px}
.panel{display:none}
.panel.active{display:block}
textarea.code{
  width:100%; min-height:220px; background:var(--codebg); color:var(--text);
  border:1px solid rgba(var(--border-rgba),.25);
  border-radius:12px; padding:12px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
  font-size:13px; line-height:1.5
}
.actions{display:flex; gap:8px; margin-top:8px}
.actions button{background:var(--surface); border:1px solid rgba(var(--border-rgba),.25); color:var(--text)}
.actions button:hover{border-color:var(--primary); color:var(--primary)}

footer{margin:32px 0; text-align:center; color:var(--muted); font-size:13px}

/* Toast */
.toast{
  position:fixed; inset:auto 20px 20px auto;
  background:var(--toast-bg); color:var(--toast-text);
  border:1px solid rgba(16,185,129,.35);
  padding:10px 12px; border-radius:10px; display:none; box-shadow:var(--shadow)
}
.toast.show{display:block}

/* Responsivo */
@media (max-width:900px){
  .grid{grid-template-columns:1fr}
  .grid-compl{grid-template-columns:1fr}
  .result.show{grid-template-columns:1fr}
  .header{flex-direction:column}
  .theme-toggle{align-self:flex-end}
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <button id="themeToggle" class="theme-toggle" type="button" aria-label="Alternar tema claro/escuro">
      <span class="icon" id="themeIcon">üåô</span>
      <span class="label" id="themeLabel">Tema: Escuro</span>
    </button>
  </div>

  <h1>Buscador de Livros</h1>
  <div class="sub">Multibases (OpenLibrary, Google Books, Internet Archive, Gutenberg, Wikisource) + MARC 21 Bibliogr√°fico e Autoridade</div>

  <div class="card">
    <!-- Busca principal -->
    <div class="grid">
      <input id="titulo" placeholder="T√≠tulo do livro"/>
      <input id="autor" placeholder="Autor(a)"/>
      <div style="display:flex; gap:8px;">
        <button id="buscarDados" class="cta" style="flex:1">Buscar</button>
        <button id="limpar" class="ghost" style="flex:1">Limpar</button>
      </div>
    </div>

    <!-- Dados complementares -->
    <div style="margin-top:12px">
      <label><strong>Dados complementares</strong></label>
      <div class="grid-compl" style="margin-top:8px; align-items:center">
        <input id="edicao" placeholder="Edi√ß√£o (ex.: 2. ed.)"/>
        <input id="ano" placeholder="Ano (ex.: 2021)"/>
        <div style="display:grid; grid-template-columns: 1fr auto; gap:8px;">
          <input id="isbn" placeholder="ISBN (10 ou 13 d√≠gitos)"/>
          <button id="buscarISBNmini" class="small-btn" title="Buscar por ISBN">ISBN</button>
        </div>
      </div>
      <small style="color:var(--muted)">Preencher ISBN prioriza a busca por n√∫mero.</small>
    </div>

    <!-- Fontes -->
    <div class="sources" id="sources">
      <span class="chip" id="s-ol"><span class="dot"></span>OpenLibrary</span>
      <span class="chip" id="s-gb"><span class="dot"></span>Google Books</span>
      <span class="chip" id="s-ia"><span class="dot"></span>Internet Archive</span>
      <span class="chip" id="s-gut"><span class="dot"></span>Project Gutenberg</span>
      <span class="chip" id="s-ws"><span class="dot"></span>Wikisource</span>
      <span class="chip" id="s-wd"><span class="dot"></span>Wikidata (Autoridade)</span>
      <span class="chip warn"><span class="dot"></span>Amazon (link)</span>
      <span class="chip warn"><span class="dot"></span>Goodreads/LibraryThing (link)</span>
    </div>
  </div>

  <!-- Skeleton -->
  <div class="skeleton" id="sk">
    <div class="sk-thumb"></div>
    <div>
      <div class="sk-line" style="width:60%"></div><br/>
      <div class="sk-line" style="width:90%"></div><br/>
      <div class="sk-line" style="width:70%"></div><br/>
      <div class="sk-line" style="width:40%"></div>
    </div>
  </div>

  <!-- Resultado -->
  <div class="result" id="result">
    <div class="cover">
      <img id="coverMain" alt="Capa"/>
      <div class="carousel" id="carousel"></div>
    </div>
    <div class="meta">
      <div class="kv" id="kv"></div>
      <div class="links" id="links"></div>

      <div class="meta-tabs">
        <button class="meta-tab active" data-panel="marcBib">MARC Bibliogr√°fico</button>
        <button class="meta-tab" data-panel="marcAuth">MARC Autoridade (Autor)</button>
        <button class="meta-tab" data-panel="dc">Dublin Core</button>
        <button class="meta-tab" data-panel="json">JSON Consolidado</button>
      </div>

      <div class="meta-panels">
        <div id="marcBib" class="panel active">
          <textarea id="marcBibText" class="code" readonly></textarea>
          <div class="actions">
            <button data-copy="marcBibText">Copiar</button>
            <button data-download="marcBibText" data-fn="marc_bibliografico.mrk">Baixar .mrk</button>
          </div>
        </div>

        <div id="marcAuth" class="panel">
          <textarea id="marcAuthText" class="code" readonly></textarea>
          <div class="actions">
            <button data-copy="marcAuthText">Copiar</button>
            <button data-download="marcAuthText" data-fn="marc_autoridade.mrk">Baixar .mrk</button>
          </div>
        </div>

        <div id="dc" class="panel">
          <textarea id="dcText" class="code" readonly></textarea>
          <div class="actions">
            <button data-copy="dcText">Copiar</button>
            <button data-download="dcText" data-fn="dublin_core.xml">Baixar .xml</button>
          </div>
        </div>

        <div id="json" class="panel">
          <textarea id="jsonText" class="code" readonly></textarea>
          <div class="actions">
            <button data-copy="jsonText">Copiar</button>
            <button data-download="jsonText" data-fn="metadata.json">Baixar .json</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <footer>&copy; 2025 Marcelo Diniz ‚Äî Vers√£o multibase com MARC Bibliogr√°fico + MARC de Autoridade</footer>

  <div style="text-align:center; font-size:14px; color:var(--muted); margin-top:8px;">
    üí° Apoie esta iniciativa. Projeto pessoal mantido com recursos pr√≥prios. Contribui√ß√µes via PIX s√£o volunt√°rias.
  </div>
  <div style="text-align:center; margin-top:6px;">
    <button style="padding:6px 16px; background:var(--accent); color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600;"
      onclick="navigator.clipboard.writeText('2bc6d233-7e5c-4407-b5d7-8aa9e96e6093').then(()=>alert('Chave PIX copiada para sua √°rea de transfer√™ncia!'))">
      üì≤ PIX Copia e Cola
    </button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ===== TEMA ===== */
(function initTheme(){
  const root=document.documentElement;
  const saved=localStorage.getItem('theme');
  const prefersLight=window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
  const initial=saved || (prefersLight?'light':'dark');
  root.setAttribute('data-theme', initial);
  updateThemeUI(initial);
})();
function toggleTheme(){
  const root=document.documentElement;
  const next = root.getAttribute('data-theme')==='light' ? 'dark' : 'light';
  root.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
  updateThemeUI(next);
}
function updateThemeUI(mode){
  const icon=document.getElementById('themeIcon');
  const label=document.getElementById('themeLabel');
  if(mode==='light'){ icon.textContent='‚òÄÔ∏è'; label.textContent='Tema: Claro'; }
  else { icon.textContent='üåô'; label.textContent='Tema: Escuro'; }
}
document.getElementById('themeToggle').addEventListener('click', toggleTheme);

/* ===== Util ===== */
const $ = (q)=>document.querySelector(q);
const $$ = (q)=>document.querySelectorAll(q);
const toast = (msg)=>{ const t=$("#toast"); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1800); };
const setChip=(id,state)=>{const el=$("#"+id); el.classList.remove('ok','err','warn'); if(state==='ok') el.classList.add('ok'); else if(state==='err') el.classList.add('err'); else if(state==='warn') el.classList.add('warn');};

/* ===== Actions copy/download ===== */
document.addEventListener('click',(e)=>{
  if(e.target.matches('[data-copy]')){
    const id=e.target.getAttribute('data-copy');
    navigator.clipboard.writeText( $('#'+id).value ).then(()=>toast('Copiado para a √°rea de transfer√™ncia'));
  }
  if(e.target.matches('[data-download]')){
    const id=e.target.getAttribute('data-download');
    const fn=e.target.getAttribute('data-fn');
    const blob=new Blob([$('#'+id).value],{type:'text/plain'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob); a.download=fn; a.click(); URL.revokeObjectURL(a.href);
  }
});

/* ===== Handlers ===== */
$('#buscarDados').addEventListener('click', ()=> {
  search({
    title: $('#titulo').value.trim(),
    author: $('#autor').value.trim(),
    isbn: $('#isbn').value.trim(),
    edicao: $('#edicao').value.trim(),
    ano: $('#ano').value.trim()
  });
});
$('#buscarISBNmini').addEventListener('click', ()=> {
  const isbn=$('#isbn').value.trim();
  if(!isbn){ toast('Informe um ISBN.'); return; }
  search({isbn});
});
$('#limpar').addEventListener('click', clearAll);

['#titulo','#autor','#isbn','#edicao','#ano'].forEach(id=>{
  const el=$(id); if(!el) return;
  el.addEventListener('keypress', (ev)=>{ 
    if(ev.key==='Enter'){ ev.preventDefault(); $('#buscarDados').click(); }
  });
});

/* ===== Helpers remotos ===== */
async function safeJson(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error('HTTP '+r.status);
  return r.json();
}
const cleanISBN = s => (s||'').replace(/[^0-9X]/gi,'');
const nowMarcDT = ()=> new Date().toISOString().replace(/[-:.TZ]/g,'').slice(0,14);
const yyyymmdd = (d=new Date())=> d.toISOString().slice(0,10).replace(/-/g,'');

/* ===== Fetchers por fonte ===== */
function gbToMeta(v){
  return {
    source:'gb',
    title:v.title, subtitle:v.subtitle, authors:v.authors||[],
    publishedDate:v.publishedDate, pageCount:v.pageCount, publisher:v.publisher,
    language:v.language, categories:v.categories||[],
    description:v.description,
    identifiers:v.industryIdentifiers||[],
    cover: v.imageLinks ? (v.imageLinks.large||v.imageLinks.medium||v.imageLinks.thumbnail||'').replace('http:','https:') : '',
    links:{ google:v.infoLink||'' }
  };
}
async function fromGoogleBooksByISBN(isbn){
  try{
    const j=await safeJson(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`);
    if(!j.items || !j.items.length) return null;
    return gbToMeta(j.items[0].volumeInfo);
  }catch{ return null; }
}
async function fromGoogleBooksByQuery(q){
  try{
    const j=await safeJson(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(q)}`);
    if(!j.items || !j.items.length) return null;
    return gbToMeta(j.items[0].volumeInfo);
  }catch{ return null; }
}
async function fromOpenLibraryByISBN(isbn){
  try{
    const j=await safeJson(`https://openlibrary.org/api/books?bibkeys=ISBN:${isbn}&format=json&jscmd=data`);
    const b=j[`ISBN:${isbn}`]; if(!b) return null;
    const title=b.title, authors=(b.authors||[]).map(a=>a.name);
    const cover=b.cover ? (b.cover.large||b.cover.medium||b.cover.small) : '';
    let description='', workKey = b.works && b.works[0] ? b.works[0].key : '';
    if(workKey){
      try{ const w=await safeJson(`https://openlibrary.org${workKey}.json`);
           description = typeof w.description==='object' ? (w.description.value||'') : (w.description||''); }catch{}
    }
    return {
      source:'ol',
      title, authors,
      publishedDate: b.publish_date,
      pageCount: b.number_of_pages,
      publisher: (b.publishers||[]).map(p=>p.name).join('; '),
      language: (b.languages||[])[0]?.key?.split('/').pop(),
      categories: [],
      description,
      identifiers:[{type:'ISBN_13',identifier:isbn}],
      cover,
      links:{ openlibrary: b.url||'' },
      extra:{ workKey, edition: (b.identifiers?.openlibrary||[])[0] }
    };
  }catch{ return null; }
}
async function fromOpenLibrarySearch(title,author){
  try{
    const params = new URLSearchParams();
    if(title) params.set('title', title);
    if(author) params.set('author', author);
    const j=await safeJson(`https://openlibrary.org/search.json?${params.toString()}`);
    if(!j.docs || !j.docs.length) return null;
    const d=j.docs[0];
    const cover = d.cover_i ? `https://covers.openlibrary.org/b/id/${d.cover_i}-L.jpg` : '';
    let description=''; if(d.key){
      try{ const w=await safeJson(`https://openlibrary.org${d.key}.json`);
           description = typeof w.description==='object' ? (w.description.value||'') : (w.description||''); }catch{}
    }
    return {
      source:'ol',
      title:d.title, authors:d.author_name||[],
      publishedDate: d.first_publish_year,
      pageCount: d.number_of_pages_median,
      publisher:(d.publisher||[]).slice(0,3).join('; '),
      language:(d.language||[])[0],
      categories:[],
      description,
      identifiers:[ {type:'ISBN_13',identifier:(d.isbn||[])[0]} ],
      cover,
      links:{ openlibrary: d.key?`https://openlibrary.org${d.key}`:'' },
      extra:{ workKey:d.key, edition:(d.edition_key||[])[0] }
    };
  }catch{ return null; }
}
async function fromInternetArchive(q){
  try{
    const query = `(${q}) AND mediatype:texts`;
    const j=await safeJson(`https://archive.org/advancedsearch.php?q=${encodeURIComponent(query)}&fl[]=identifier&fl[]=title&fl[]=creator&fl[]=year&fl[]=language&output=json&rows=3`);
    if(!j.response || !j.response.docs.length) return null;
    const d=j.response.docs[0];
    return {
      source:'ia',
      title:d.title, authors: d.creator ? [d.creator] : [],
      publishedDate:d.year, language:d.language,
      cover: `https://archive.org/services/img/${d.identifier}`,
      links:{ archive:`https://archive.org/details/${d.identifier}` }
    };
  }catch{ return null; }
}
function gutToMeta(b){
  return {
    source:'gut',
    title:b.title, authors:b.authors?.map(a=>a.name)||[],
    language:(b.languages||[])[0],
    publishedDate:'', categories: b.subjects||[],
    cover:b.formats?.['image/jpeg']||'',
    links:{ gutenberg:b.formats?.['text/html']||b.formats?.['application/epub+zip']||'' }
  };
}
async function fromGutendex(title,author){
  try{
    const j=await safeJson(`https://gutendex.com/books?search=${encodeURIComponent(title + (author?(' '+author):''))}`);
    if(!j.results || !j.results.length) return null;
    return gutToMeta(j.results[0]);
  }catch{ return null; }
}
async function checkWikisource(title){
  try{
    const j=await safeJson(`https://pt.wikisource.org/w/api.php?action=query&format=json&origin=*&titles=${encodeURIComponent(title)}`);
    const pages=j.query?.pages||{};
    const pid=Object.keys(pages)[0];
    if(pid && pid!=='-1'){
      return { source:'ws', exists:true, url:`https://pt.wikisource.org/wiki/${encodeURIComponent(title.replace(/\s/g,'_'))}` };
    }
    return { source:'ws', exists:false };
  }catch{ return { source:'ws', exists:false }; }
}
/* Wikidata (autoridade) */
async function getWikidataForAuthor(name){
  try{
    const search=await safeJson(`https://www.wikidata.org/w/api.php?action=wbsearchentities&search=${encodeURIComponent(name)}&language=pt&format=json&origin=*`);
    if(!search.search || !search.search.length) return null;
    const id=search.search[0].id;
    const ent=await safeJson(`https://www.wikidata.org/wiki/Special:EntityData/${id}.json?origin=*`);
    const e=ent.entities[id];
    const lab=(e.labels?.pt?.value)|| (e.labels?.en?.value)|| name;
    const aliases=(e.aliases?.pt||[]).map(a=>a.value).slice(0,8);
    function val(prop){ return e.claims?.[prop]?.[0]?.mainsnak?.datavalue?.value; }
    function valTime(prop){ const v=val(prop); if(!v || !v.time) return ''; return v.time.replace('+','').slice(1,11); }
    const VIAF = val('P214'), ISNI = val('P213');
    const birth = valTime('P569'), death = valTime('P570');
    const placeBirth = val('P19')?.id, placeDeath = val('P20')?.id, citizen = val('P27')?.id;
    const occupations = (e.claims?.P106||[]).map(c=>c.mainsnak?.datavalue?.value?.id).slice(0,5);
    const ids = [placeBirth,placeDeath,citizen,...occupations].filter(Boolean);
    let labels={};
    if(ids.length){
      const r=await safeJson(`https://www.wikidata.org/w/api.php?action=wbgetentities&ids=${ids.join('|')}&props=labels&languages=pt|en&format=json&origin=*`);
      for(const k in r.entities){ labels[k]= r.entities[k].labels.pt?.value || r.entities[k].labels.en?.value || ''; }
    }
    return { id, label:lab, aliases, VIAF, ISNI, birth, death,
             placeBirth: labels[placeBirth]||'', placeDeath: labels[placeDeath]||'',
             citizen: labels[citizen]||'',
             occupations: occupations.map(id=>labels[id]||'').filter(Boolean) };
  }catch{ return null; }
}

/* ===== Helpers de formata√ß√£o ===== */
function surnameFirst(name){
  if(!name) return 'Desconhecido';
  const parts=name.trim().split(/\s+/);
  if(parts.length===1) return name;
  const last=parts.pop();
  return `${last}, ${parts.join(' ')}`;
}
function buildMARCbib(meta){
  const isbn = meta.isbn || '';
  const author = (meta.authors||[])[0] || 'Desconhecido';
  const authorNorm = surnameFirst(author);
  const pubYear = (meta.publishedDate||'').toString().slice(0,4) || 'xxxx';
  const pages = meta.pageCount || '???';
  const title = meta.title || 'Sem t√≠tulo';
  const subtitle = meta.subtitle || '';
  const desc = (meta.description||'').replace(/\r?\n/g,' ').slice(0,2000);
  const cover = meta.cover || '';
  const googleLink = meta.links?.google || '';
  const today = yyyymmdd();
  return [
`=LDR  01019nam a2200301 a 4500`,
`=001  ${isbn||meta.extra?.workKey||'ID'}`,
`=003  BR-Marcelo`,
`=005  ${nowMarcDT()}`,
`=008  ${today}s${pubYear}    xxu||||| |||| 00| 0 por d`,
`=010  __$a${isbn}`,
`=020  __$a${isbn}`,
`=035  __$a(${(meta.source||'SRC').toUpperCase()})${isbn||meta.extra?.workKey||'N/A'}`,
`=040  __$aBR-$bpor$cBR-`,
`=041  0_$apor`,
`=100  1_$a${authorNorm}`,
`=245  10$a${title}${subtitle?`: ${subtitle}`:''} /$c${authorNorm}.`,
`=250  __$a${meta.edicao||'1. ed.'}`,
`=260  __$a[S.l.] :$b[s.n.],$c${pubYear}.`,
`=300  __$a${pages} p. :$bil. ;$c21 cm`,
`=336  __$atexto$btxt$2rdacontent`,
`=337  __$asem m√≠dia$bn$2rdamedia`,
`=338  __$avolume$bnc$2rdacarrier`,
`=504  __$aInclui refer√™ncias bibliogr√°ficas.`,
`=520  __$a${desc||'Resumo n√£o dispon√≠vel.'}`,
`=546  __$aTexto em portugu√™s.`,
`=650  _0$a${(meta.categories||[])[0]||'Obras diversas.'}`,
`=700  1_$a${(meta.authors||[]).slice(1).join(' ; ')}`,
`=776  08$iVers√£o impressa:$t${title}$w${isbn}`,
`=856  41$u${cover}$yCapa$zLink da imagem`,
`=856  42$u${isbn?`https://www.amazon.com.br/s?k=${isbn}`: `https://www.amazon.com.br/s?k=${encodeURIComponent(title)}`}$zAmazon`,
`=856  43$u${googleLink}$zGoogle Books`,
`=856  44$uhttps://www.goodreads.com/search?q=${encodeURIComponent(title)}$zGoodreads`,
`=856  45$uhttps://www.librarything.com/search.php?search=${encodeURIComponent(title)}$zLibraryThing`
  ].join('\n');
}
function buildDublinCore(meta){
  const isbn = meta.isbn||'';
  return [
`<dc:title>${meta.title||'Sem t√≠tulo'}</dc:title>`,
`<dc:creator>${(meta.authors||[]).join('; ')||'Desconhecido'}</dc:creator>`,
`<dc:subject>${(meta.categories||[]).join('; ')||'N/A'}</dc:subject>`,
`<dc:description>${(meta.description||'Resumo n√£o dispon√≠vel').replace(/\r?\n/g,' ')}</dc:description>`,
`<dc:publisher>${meta.publisher||'N√£o informado'}</dc:publisher>`,
`<dc:date>${(meta.publishedDate||'xxxx').toString().slice(0,10)}</dc:date>`,
`<dc:language>${meta.language||'pt'}</dc:language>`,
`<dc:identifier>${isbn?('urn:isbn:'+isbn):'N/A'}</dc:identifier>`,
`<dc:source>${meta.links?.google||meta.links?.openlibrary||meta.links?.archive||'N/A'}</dc:source>`,
`<dc:relation>${meta.cover||'N/A'}</dc:relation>`,
`<dc:rights>N/A</dc:rights>`
  ].join('\n');
}
function buildMARCAuthority(author, wd){
  if(!author && !wd) return 'Sem dados de autoridade encontrados.';
  const name = author || wd?.label || 'Desconhecido';
  const nameNorm = surnameFirst(name);
  const dates = [wd?.birth, wd?.death].filter(Boolean).map(d=>d.slice(0,4)).join('-');
  const today = yyyymmdd();
  const lines = [];
  lines.push(`=LDR  00715nz  a2200181n  4500`);
  lines.push(`=001  ${wd?.id||'AUTHID'}`);
  lines.push(`=003  BR-Marcelo`);
  lines.push(`=005  ${nowMarcDT()}`);
  lines.push(`=008  ${today}n||azznnbabn###########n#a##########`);
  if(wd?.ISNI) lines.push(`=024  7_$a${wd.ISNI}$2isni`);
  if(wd?.VIAF) lines.push(`=024  7_$a${wd.VIAF}$2viaf`);
  lines.push(`=035  __$a(WIKIDATA)${wd?.id||''}`);
  lines.push(`=040  __$aBR-$bpor$cBR-`);
  lines.push(`=046  __$f${wd?.birth||''}$g${wd?.death||''}`);
  let d100 = `=100  1_$a${nameNorm}`;
  if(dates) d100 += `,$d${dates}`;
  lines.push(d100);
  (wd?.aliases||[]).forEach(v=>{ lines.push(`=400  1_$a${surnameFirst(v)}`); });
  if(wd?.placeBirth) lines.push(`=370  __$a${wd.placeBirth}`);
  if(wd?.placeDeath) lines.push(`=370  __$b${wd.placeDeath}`);
  if(wd?.citizen) lines.push(`=370  __$c${wd.citizen}`);
  if(wd?.occupations?.length) lines.push(`=374  __$a${wd.occupations.join(' ; ')}`);
  lines.push(`=667  __$aRegistro de autoridade gerado automaticamente a partir de Wikidata.`);
  lines.push(`=670  __$aWikidata ${wd?.id||''}, acesso em ${today}.`);
  return lines.join('\n');
}

/* ===== UI ===== */
function setSkeleton(on){ $('#sk').classList.toggle('show', !!on); }
function setResult(on){ $('#result').classList.toggle('show', !!on); }
function clearAll(){
  ['#titulo','#autor','#isbn','#edicao','#ano'].forEach(sel=>{ const el=$(sel); if(el) el.value=''; });
  setResult(false); setSkeleton(false);
  ['s-ol','s-gb','s-ia','s-gut','s-ws','s-wd'].forEach(id=>{ const el=$("#"+id); el.classList.remove('ok','err','warn'); });
}

/* ===== Populate ===== */
function populate(meta, authority, sourcesStatus){
  setChip('s-ol', sourcesStatus.ol?'ok':'');
  setChip('s-gb', sourcesStatus.gb?'ok':'');
  setChip('s-ia', sourcesStatus.ia?'ok':'');
  setChip('s-gut', sourcesStatus.gut?'ok':'');
  setChip('s-ws', sourcesStatus.ws?'ok':'');
  setChip('s-wd', authority?.wd?'ok':'');

  const covers = Array.from(new Set([meta.cover, ...(meta.extraCovers||[])] )).filter(Boolean);
  $('#coverMain').src = covers[0] || '';
  const car = $('#carousel'); car.innerHTML='';
  covers.slice(1).forEach(url=>{
    const im=document.createElement('img'); im.src=url; im.alt='Capa';
    im.addEventListener('click', ()=> { $('#coverMain').src=url; });
    car.appendChild(im);
  });

  const kv=$('#kv'); kv.innerHTML='';
  const addKV=(k,v)=>{ const kd=document.createElement('div'); kd.textContent=k; const vd=document.createElement('div'); vd.textContent=v||'N/A'; kv.appendChild(kd); kv.appendChild(vd); };
  addKV('T√≠tulo', meta.title);
  addKV('Subt√≠tulo', meta.subtitle||'');
  addKV('Autor(es)', (meta.authors||[]).join('; '));
  addKV('Edi√ß√£o', meta.edicao||'');
  addKV('Ano', (meta.publishedDate||'').toString().slice(0,4));
  addKV('P√°ginas', meta.pageCount||'');
  addKV('Idioma', meta.language||'');
  addKV('Assuntos', (meta.categories||[]).join('; '));
  addKV('Editora', meta.publisher||'');
  addKV('ISBN', meta.isbn||'');

  const links=$('#links'); links.innerHTML='';
  const lb = (href,txt)=>{ if(!href) return; const a=document.createElement('a'); a.href=href; a.target='_blank'; a.className='btn'; a.textContent=txt; links.appendChild(a); };
  lb(meta.links?.google,'Google Books');
  lb(meta.links?.openlibrary,'OpenLibrary');
  lb(meta.links?.archive,'Internet Archive');
  lb(meta.links?.gutenberg,'Gutenberg');
  lb(meta.links?.wikisource,'Wikisource');
  lb(meta.isbn?`https://www.amazon.com.br/s?k=${meta.isbn}`:`https://www.amazon.com.br/s?k=${encodeURIComponent(meta.title||'')}`,'Amazon');
  lb(`https://www.goodreads.com/search?q=${encodeURIComponent(meta.title||'')}`,'Goodreads');
  lb(`https://www.librarything.com/search.php?search=${encodeURIComponent(meta.title||'')}`,'LibraryThing');

  $('#marcBibText').value = buildMARCbib(meta);
  $('#dcText').value = buildDublinCore(meta);
  $('#marcAuthText').value = buildMARCAuthority( (meta.authors||[])[0], authority?.wd || null );
  $('#jsonText').value = JSON.stringify({meta, authority}, null, 2);

  setSkeleton(false); setResult(true);
  $('#result').scrollIntoView({behavior:'smooth'});
}

/* ===== Merge ===== */
function prefer(a,b){ return a ?? b; }
function mergeMeta(base, plus){
  if(!plus) return base;
  return {
    source: base.source || plus.source,
    title: prefer(base.title, plus.title),
    subtitle: base.subtitle || plus.subtitle,
    authors: (base.authors?.length? base.authors: plus.authors)||[],
    publishedDate: prefer(base.publishedDate, plus.publishedDate),
    pageCount: prefer(base.pageCount, plus.pageCount),
    publisher: prefer(base.publisher, plus.publisher),
    language: prefer(base.language, plus.language),
    categories: (base.categories?.length? base.categories: plus.categories)||[],
    description: prefer(base.description, plus.description),
    identifiers: (base.identifiers||[]).concat(plus.identifiers||[]),
    isbn: base.isbn || plus.identifiers?.find(i=>i.type && i.type.startsWith('ISBN'))?.identifier || '',
    cover: base.cover || plus.cover || '',
    extraCovers: [...new Set([...(base.extraCovers||[]), plus.cover].filter(Boolean))],
    links: {...(base.links||{}), ...(plus.links||{})},
    extra: {...(base.extra||{}), ...(plus.extra||{})},
    // complementares
    edicao: base.edicao || plus.edicao
  };
}

/* ===== Orquestra√ß√£o da busca ===== */
async function search({title,author,isbn,edicao,ano}){
  setResult(false); setSkeleton(true);
  ['s-ol','s-gb','s-ia','s-gut','s-ws','s-wd'].forEach(id=>{ const el=$("#"+id); el.classList.remove('ok','err','warn'); });

  let meta=null, status={ol:false,gb:false,ia:false,gut:false,ws:false,wd:false};

  try{
    if(isbn){
      isbn = cleanISBN(isbn);
      const g = await fromGoogleBooksByISBN(isbn); if(g){ status.gb=true; g.isbn = isbn; meta = mergeMeta({isbn}, g); }
      const o = await fromOpenLibraryByISBN(isbn); if(o){ status.ol=true; o.isbn = isbn; meta = meta? mergeMeta(meta,o): {...o, isbn}; }
    } else {
      const o = await fromOpenLibrarySearch(title,author); if(o){ status.ol=true; meta = {...o, isbn: (o.identifiers?.find(i=>i.type && i.type.startsWith('ISBN'))?.identifier)||''}; }
      const q = [title?`intitle:${title}`:'', author?`inauthor:${author}`:''].filter(Boolean).join('+');
      const g = await fromGoogleBooksByQuery(q||title||author||''); if(g){ status.gb=true; meta = meta? mergeMeta(meta,g): g; }
    }

    if(!meta) { setSkeleton(false); toast('Nenhum resultado. Ajuste os termos ou informe o ISBN.'); return; }

    // aplicar dados complementares
    if(edicao) meta.edicao = edicao;
    if(ano) meta.publishedDate = ano + (meta.publishedDate && String(meta.publishedDate).length>4 ? String(meta.publishedDate).slice(4) : '');

    const qIA = [meta.title, (meta.authors||[])[0]].filter(Boolean).join(' ');
    const ia = await fromInternetArchive(qIA); if(ia){ status.ia=true; meta = mergeMeta(meta, ia); }
    const gut = await fromGutendex(meta.title||title||'', (meta.authors||[])[0]||author||''); if(gut){ status.gut=true; meta = mergeMeta(meta, gut); }
    const ws = await checkWikisource(meta.title||title||''); if(ws && ws.exists){ status.ws=true; meta.links = {...(meta.links||{}), wikisource: ws.url}; }

    let authority=null;
    const authName = (meta.authors||[])[0];
    if(authName){ const wd = await getWikidataForAuthor(authName); if(wd){ status.wd=true; authority = { wd }; } }

    populate(meta, authority, status);
  }catch(err){
    setSkeleton(false);
    toast('Erro de rede ou CORS. Tente novamente.');
    console.error(err);
  }
}

/* ===== Abas de metadado ===== */
$$('.meta-tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    $$('.meta-tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const p=btn.dataset.panel;
    $$('.panel').forEach(pa=>pa.classList.remove('active'));
    $('#'+p).classList.add('active');
  });
});

/* ===== Init ===== */
setResult(false);
</script>
</body>
</html>
